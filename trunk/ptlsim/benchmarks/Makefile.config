# -*- makefile -*-

CC = gcc
CCLINK = gcc
CFLAGS = -DBENCHMARK -DSPEC_CPU2000 -O3 -march=k8 -m64 -funroll-loops -fno-trapping-math -mfpmath=sse -funit-at-a-time -fprefetch-loop-arrays -include ../../ptlcalls.h
FFLAGS = -DBENCHMARK -DSPEC_CPU2000 -O3 -march=k8 -m64 -funroll-loops -fno-trapping-math -mfpmath=sse -funit-at-a-time -fprefetch-loop-arrays -include ../../ptlcalls.h

FORTRANFLAGS = -lfrtbegin -lg2c ../../ptlcalls.o
LINKFLAGS = -lm

# In component Makefiles, add the following to enable Fortran compilation:
# USE_FORTRAN = $(FORTRANFLAGS)
USE_FORTRAN = 

.c.o:
	$(CC) -c $(CFLAGS) $^

.f.o:
	g77 -c $(CFLAGS) $^

.cpp.o:
	g++ -c $(CFLAGS) $^

.cc.o:
	g++ -c $(CFLAGS) $^

all: $(OUTPUT)

test.dat.S: test.dat
	objdump -rtd -b binary -m i386:x86-64:intel --disassemble-all test.dat > test.dat.S
	objdump -rtd -b binary -m i386:x86-64 --disassemble-all test.dat > test.dat.alt.S

$(OUTPUT): $(SOURCES)
	$(CCLINK) $(CFLAGS) $(SOURCES) -o $(OUTPUT) $(USE_FORTRAN) $(LINKFLAGS)

run:
	ptlsim $(COMMAND)
	ptlstats ptlsim.stats > ptlsim.stats.txt

clean:
	rm -f *.o $(OUTPUT)

