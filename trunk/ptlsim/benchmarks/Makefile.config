# -*- makefile -*-

CC = gcc
CCLINK = gcc
CFLAGS = -DBENCHMARK -DSPEC_CPU2000 -O3 -march=k8 -m64 -funroll-loops -fno-trapping-math -mfpmath=sse -funit-at-a-time -fprefetch-loop-arrays -include ../../ptlcalls.h
FFLAGS = -DBENCHMARK -DSPEC_CPU2000 -O3 -march=k8 -m64 -funroll-loops -fno-trapping-math -mfpmath=sse -funit-at-a-time -fprefetch-loop-arrays -include ../../ptlcalls.h

FORTRANFLAGS = -lfrtbegin -lg2c ../../ptlcalls.o
LINKFLAGS = -lm

# In component Makefiles, add the following to enable Fortran compilation:
# USE_FORTRAN = $(FORTRANFLAGS)
USE_FORTRAN = 

.c.o:
	$(CC) -c $(CFLAGS) $^

.f.o:
	g77 -c $(CFLAGS) $^

.cpp.o:
	g++ -c $(CFLAGS) $^

.cc.o:
	g++ -c $(CFLAGS) $^

all: $(OUTPUT)

test.dat.S: test.dat
	objdump -rtd -b binary -m i386:x86-64:intel --disassemble-all test.dat > test.dat.S
	objdump -rtd -b binary -m i386:x86-64 --disassemble-all test.dat > test.dat.alt.S

$(OUTPUT): $(SOURCES)
	$(CCLINK) $(CFLAGS) $(SOURCES) -o $(OUTPUT) $(USE_FORTRAN) $(LINKFLAGS)

run:
	../../ptlsim $(COMMAND)
	ptlstats ptlsim.stats > ptlsim.stats.txt

graphs:
	ptlstats -dump ptlsim.stats > ptlsim.statlog
	ptlstats -graph-phasedist ptlsim.stats > phasedist.svg
	ptlstats -graph-cycledist ptlsim.stats > cycledist.svg
	ptlstats -depthpercent ptlsim.stats > commit-depth-in-percent.svg
	ptlstats -depthtags ptlsim.stats > commit-depth-in-tags.svg
	inkprint phasedist.svg --export-ps=phasedist.ps
	inkprint cycledist.svg --export-ps=cycledist.ps
	inkprint commit-depth-in-percent.svg --export-ps=commit-depth-in-percent.ps
	inkprint commit-depth-in-tags.svg --export-ps=commit-depth-in-tags.ps

graphs-atomic:
	ptlstats -dump ptlsim.stats.atomic > ptlsim.statlog.atomic
	ptlstats -graph-phasedist ptlsim.stats.atomic > phasedist.atomic.svg
	ptlstats -graph-cycledist ptlsim.stats.atomic > cycledist.atomic.svg
	ptlstats -depthpercent ptlsim.stats.atomic > commit-depth-in-percent.atomic.svg
	ptlstats -depthtags ptlsim.stats.atomic > commit-depth-in-tags.atomic.svg
	inkprint phasedist.atomic.svg --export-ps=phasedist.atomic.ps
	inkprint cycledist.atomic.svg --export-ps=cycledist.atomic.ps
	inkprint commit-depth-in-percent.atomic.svg --export-ps=commit-depth-in-percent.atomic.ps
	inkprint commit-depth-in-tags.atomic.svg --export-ps=commit-depth-in-tags.atomic.ps

clean:
	rm -f *.o $(OUTPUT)

